<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Audits | Sustainability</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .audits-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            margin-bottom: 30px;
        }

        .header-section h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .audit-types {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .audit-type-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .audit-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .audit-type-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .audit-type-card .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .audit-type-card p {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .btn-create {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-create:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
        }

        .audits-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ecf0f1;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            color: #7f8c8d;
        }

        .tab:hover {
            background: #ecf0f1;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .audit-item {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .audit-item:hover {
            background: #f8f9fa;
        }

        .audit-item:last-child {
            border-bottom: none;
        }

        .audit-info {
            flex: 1;
        }

        .audit-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .audit-meta {
            font-size: 13px;
            color: #7f8c8d;
        }

        .audit-score {
            text-align: right;
            margin: 0 30px;
        }

        .score-value {
            font-size: 20px;
            font-weight: bold;
            color: #2ecc71;
        }

        .score-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .audit-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .btn-view:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .filter-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            gap: 10px;
        }

        .filter-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .audit-types {
                grid-template-columns: 1fr;
            }

            .audit-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .audit-score {
                margin: 10px 0;
                text-align: left;
            }

            .audit-actions {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="audits-container">
        <div class="header-section">
            <h1>üìä My Audit Reports</h1>
            <p>Manage and review your sustainability audits</p>
        </div>

        <!-- Quick Action Cards -->
        <div class="audit-types">
            <div class="audit-type-card" onclick="window.location.href='carbon-audit.html'">
                <div class="icon">üåç</div>
                <h3>Carbon Emission</h3>
                <p>Calculate your facility's carbon footprint</p>
                <button class="btn-create">Create New</button>
            </div>

            <div class="audit-type-card" onclick="window.location.href='igbc-audit.html'">
                <div class="icon">üè¢</div>
                <h3>IGBC Green Building</h3>
                <p>Evaluate green building credentials</p>
                <button class="btn-create">Create New</button>
            </div>

            <div class="audit-type-card" onclick="window.location.href='esg-audit.html'">
                <div class="icon">üå±</div>
                <h3>ESG Assessment</h3>
                <p>Comprehensive sustainability review</p>
                <button class="btn-create">Create New</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-number" id="carbonCount">0</div>
                <div class="stat-label">Carbon Audits</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="igbcCount">0</div>
                <div class="stat-label">IGBC Audits</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="esgCount">0</div>
                <div class="stat-label">ESG Audits</div>
            </div>
        </div>

        <!-- Audits List -->
        <div class="audits-list">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('carbon')">üåç Carbon Emission</div>
                <div class="tab" onclick="switchTab('igbc')">üè¢ IGBC Green Building</div>
                <div class="tab" onclick="switchTab('esg')">üå± ESG Assessment</div>
            </div>

            <!-- Carbon Audits Tab -->
            <div id="carbon" class="tab-content active">
                <div class="filter-section">
                    <input type="text" class="filter-input" id="carbonSearch" placeholder="Search by facility name..." onkeyup="filterAudits('carbon')">
                </div>
                <div id="carbonList" class="loading">Loading audits...</div>
            </div>

            <!-- IGBC Audits Tab -->
            <div id="igbc" class="tab-content">
                <div class="filter-section">
                    <input type="text" class="filter-input" id="igbcSearch" placeholder="Search by building name..." onkeyup="filterAudits('igbc')">
                </div>
                <div id="igbcList" class="loading">Loading audits...</div>
            </div>

            <!-- ESG Audits Tab -->
            <div id="esg" class="tab-content">
                <div class="filter-section">
                    <input type="text" class="filter-input" id="esgSearch" placeholder="Search by organization name..." onkeyup="filterAudits('esg')">
                </div>
                <div id="esgList" class="loading">Loading audits...</div>
            </div>
        </div>
    </div>

    <script src="audit-api.js"></script>
    <script>
        let allAudits = {
            carbon: [],
            igbc: [],
            esg: []
        };

        let auditAPI;

        function checkAuthentication() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please log in first to view and create audits');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

            // Show selected tab
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadAudits() {
            // Check authentication first
            if (!checkAuthentication()) {
                return;
            }

            try {
                // Load Carbon Audits
                const carbonResponse = await auditAPI.listCarbonAudits();
                if (carbonResponse.success) {
                    allAudits.carbon = carbonResponse.audits || [];
                    displayCarbonAudits(allAudits.carbon);
                    document.getElementById('carbonCount').textContent = allAudits.carbon.length;
                }

                // Load IGBC Audits
                const igbcResponse = await auditAPI.listIGBCAudits();
                if (igbcResponse.success) {
                    allAudits.igbc = igbcResponse.audits || [];
                    displayIGBCAudits(allAudits.igbc);
                    document.getElementById('igbcCount').textContent = allAudits.igbc.length;
                }

                // Load ESG Audits
                const esgResponse = await auditAPI.listESGAudits();
                if (esgResponse.success) {
                    allAudits.esg = esgResponse.audits || [];
                    displayESGAudits(allAudits.esg);
                    document.getElementById('esgCount').textContent = allAudits.esg.length;
                }
            } catch (error) {
                console.error('Error loading audits:', error);
            }
        }

        function displayCarbonAudits(audits) {
            const list = document.getElementById('carbonList');
            if (audits.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No Carbon Audits Found</h3>
                        <p>Create a new carbon emission audit to get started</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = audits.map(audit => `
                <div class="audit-item">
                    <div class="audit-info">
                        <div class="audit-name">${audit.facility_name}</div>
                        <div class="audit-meta">
                            üìÖ ${new Date(audit.created_at).toLocaleDateString()} | 
                            üè≠ ${audit.audit_period}
                        </div>
                        <div class="audit-meta">Total Emissions: <strong>${audit.total_carbon_footprint} kg CO‚ÇÇ</strong></div>
                    </div>
                    <div class="audit-score">
                        <div class="score-value">${audit.emissions.total_carbon_footprint}</div>
                        <div class="score-label">kg CO‚ÇÇ</div>
                    </div>
                    <div class="audit-actions">
                        <button class="btn-small btn-view" onclick="viewAudit('carbon', '${audit.id}')">View</button>
                        <button class="btn-small btn-delete" onclick="deleteAudit('carbon', '${audit.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displayIGBCAudits(audits) {
            const list = document.getElementById('igbcList');
            if (audits.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No IGBC Audits Found</h3>
                        <p>Create a new IGBC green building audit to get started</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = audits.map(audit => `
                <div class="audit-item">
                    <div class="audit-info">
                        <div class="audit-name">${audit.building_name}</div>
                        <div class="audit-meta">
                            üìÖ ${new Date(audit.created_at).toLocaleDateString()} | 
                            üè¢ ${audit.audit_period}
                        </div>
                        <div class="audit-meta">Rating: <strong>${audit.rating}</strong></div>
                    </div>
                    <div class="audit-score">
                        <div class="score-value">${audit.total_score}</div>
                        <div class="score-label">/ 100</div>
                    </div>
                    <div class="audit-actions">
                        <button class="btn-small btn-view" onclick="viewAudit('igbc', '${audit.id}')">View</button>
                        <button class="btn-small btn-delete" onclick="deleteAudit('igbc', '${audit.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displayESGAudits(audits) {
            const list = document.getElementById('esgList');
            if (audits.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No ESG Audits Found</h3>
                        <p>Create a new ESG audit to get started</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = audits.map(audit => `
                <div class="audit-item">
                    <div class="audit-info">
                        <div class="audit-name">${audit.organization_name}</div>
                        <div class="audit-meta">
                            üìÖ ${new Date(audit.created_at).toLocaleDateString()} | 
                            üå± ${audit.audit_period}
                        </div>
                        <div class="audit-meta">Rating: <strong>${audit.esg_rating}</strong></div>
                    </div>
                    <div class="audit-score">
                        <div class="score-value">${audit.esg_score}</div>
                        <div class="score-label">/ 100</div>
                    </div>
                    <div class="audit-actions">
                        <button class="btn-small btn-view" onclick="viewAudit('esg', '${audit.id}')">View</button>
                        <button class="btn-small btn-delete" onclick="deleteAudit('esg', '${audit.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterAudits(type) {
            const query = document.getElementById(`${type}Search`).value.toLowerCase();
            let filtered;

            if (type === 'carbon') {
                filtered = allAudits.carbon.filter(a => a.facility_name.toLowerCase().includes(query));
                displayCarbonAudits(filtered);
            } else if (type === 'igbc') {
                filtered = allAudits.igbc.filter(a => a.building_name.toLowerCase().includes(query));
                displayIGBCAudits(filtered);
            } else if (type === 'esg') {
                filtered = allAudits.esg.filter(a => a.organization_name.toLowerCase().includes(query));
                displayESGAudits(filtered);
            }
        }

        async function deleteAudit(type, auditId) {
            if (!confirm('Are you sure you want to delete this audit? This action cannot be undone.')) {
                return;
            }

            try {
                let response;
                if (type === 'carbon') {
                    response = await auditAPI.deleteCarbonAudit(auditId);
                } else if (type === 'igbc') {
                    response = await auditAPI.deleteIGBCAudit(auditId);
                } else if (type === 'esg') {
                    response = await auditAPI.deleteESGAudit(auditId);
                }

                if (response.success) {
                    loadAudits();
                    alert('Audit deleted successfully!');
                } else {
                    alert('Error: ' + response.message);
                }
            } catch (error) {
                alert('Error deleting audit: ' + error.message);
            }
        }

        function viewAudit(type, auditId) {
            alert(`View functionality for ${type} audit ${auditId} would be implemented here`);
        }

        // Initialize API and load audits on page load
        window.addEventListener('load', function() {
            auditAPI = new AuditAPI();
            loadAudits();
        });
    </script>
</body>
</html>
